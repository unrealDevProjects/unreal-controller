<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Unreal Web Joystick + Jump</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        touch-action: none;
      }

      .controller-container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 30px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        margin-bottom: 20px;
      }

      .connect-btn {
        padding: 10px 20px;
        border-radius: 20px;
        border: none;
        font-size: 16px;
        font-weight: bold;
        color: white;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        cursor: pointer;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #ff4444;
      }

      .status-indicator.connected {
        background: #44ff44;
      }

      .config-panel {
        background: rgba(0, 0, 0, 0.2);
        padding: 15px;
        border-radius: 15px;
        margin-bottom: 20px;
        width: 100%;
        display: none;
      }

      .config-panel.active {
        display: block;
      }

      .config-input-group {
        margin-bottom: 10px;
      }

      .config-input-group label {
        display: block;
        color: white;
        font-size: 12px;
        margin-bottom: 5px;
      }

      .config-input-group input {
        width: 100%;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.2);
        color: white;
        font-size: 14px;
      }

      .config-input-group input::placeholder {
        color: rgba(255, 255, 255, 0.6);
      }

      .config-toggle {
        font-size: 12px;
        color: rgba(255, 255, 255, 0.8);
        cursor: pointer;
        text-decoration: underline;
        margin-top: 10px;
        display: block;
      }

      #jumpBtn {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        font-size: 20px;
        color: white;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border: 3px solid rgba(255, 255, 255, 0.3);
        margin-bottom: 20px;
        touch-action: manipulation;
        user-select: none;
      }

      #joystickZone {
        width: 200px;
        height: 200px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 50%;
        position: relative;
        touch-action: none;
      }

      #stick {
        width: 80px;
        height: 80px;
        background: rgba(255, 255, 255, 0.6);
        border-radius: 50%;
        position: absolute;
        left: 60px;
        top: 60px;
        transition: 0.05s ease;
      }
    </style>
  </head>
  <body>
    <div class="controller-container">
      <div class="status-bar">
        <button
          id="connectBtn"
          class="connect-btn"
        >
          Conectar
        </button>
        <div
          id="statusIndicator"
          class="status-indicator"
        ></div>
      </div>

      <!-- Panel de Configuración -->
      <div
        id="configPanel"
        class="config-panel"
      >
        <div class="config-input-group">
          <label for="serverIP">IP del Servidor:</label>
          <input
            type="text"
            id="serverIP"
            placeholder="Ej: 192.168.4.109 o tu-ip-publica.com"
          />
        </div>
        <div class="config-input-group">
          <label for="serverPort">Puerto:</label>
          <input
            type="text"
            id="serverPort"
            placeholder="Ej: 8081"
          />
        </div>
        <span
          id="configToggle"
          class="config-toggle"
          >Ocultar configuración</span
        >
      </div>

      <span
        id="showConfig"
        class="config-toggle"
        style="display: block; margin-bottom: 10px"
        >Mostrar configuración</span
      >

      <!-- Botón Jump -->
      <button id="jumpBtn">JUMP</button>

      <!-- Joystick -->
      <div id="joystickZone">
        <div id="stick"></div>
      </div>
    </div>

    <script>
      let socket;
      let playerID = localStorage.getItem('playerID');
      if (!playerID) {
        playerID = crypto.randomUUID();
        localStorage.setItem('playerID', playerID);
      }

      // Cargar configuración guardada
      const savedIP = localStorage.getItem('serverIP') || '192.168.4.109';
      const savedPort = localStorage.getItem('serverPort') || '8081';

      const connectBtn = document.getElementById('connectBtn');
      const statusIndicator = document.getElementById('statusIndicator');
      const configPanel = document.getElementById('configPanel');
      const showConfigBtn = document.getElementById('showConfig');
      const configToggle = document.getElementById('configToggle');
      const serverIPInput = document.getElementById('serverIP');
      const serverPortInput = document.getElementById('serverPort');

      // Cargar valores guardados en los inputs
      serverIPInput.value = savedIP;
      serverPortInput.value = savedPort;

      // Toggle del panel de configuración
      showConfigBtn.addEventListener('click', () => {
        configPanel.classList.add('active');
        showConfigBtn.style.display = 'none';
      });

      configToggle.addEventListener('click', () => {
        configPanel.classList.remove('active');
        showConfigBtn.style.display = 'block';
      });

      // Guardar configuración cuando cambie
      serverIPInput.addEventListener('change', () => {
        localStorage.setItem('serverIP', serverIPInput.value);
      });

      serverPortInput.addEventListener('change', () => {
        localStorage.setItem('serverPort', serverPortInput.value);
      });

      connectBtn.addEventListener('click', () => {
        const serverIP = serverIPInput.value || savedIP;
        const serverPort = serverPortInput.value || savedPort;
        const wsProtocol =
          window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsURL = `${wsProtocol}//${serverIP}:${serverPort}`;

        console.log('Intentando conectar a:', wsURL);
        socket = new WebSocket(wsURL);

        socket.onopen = () => {
          console.log('Conectado al servidor WebSocket');
          statusIndicator.classList.add('connected');
          connectBtn.textContent = 'Conectado';
          socket.send('NewPlayer:' + playerID);
          console.log('Web → Node.js: NewPlayer:' + playerID);
        };

        socket.onclose = () => {
          statusIndicator.classList.remove('connected');
          connectBtn.textContent = 'Conectar';
        };

        socket.onerror = () => {
          statusIndicator.classList.remove('connected');
          connectBtn.textContent = 'Error - Reintentar';
        };
      });

      function sendInput(input) {
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.send(playerID + '|' + input);
          console.log('Web → Node.js:', playerID + '|' + input);
        }
      }

      // JUMP
      const jumpBtn = document.getElementById('jumpBtn');
      jumpBtn.addEventListener('touchstart', () => sendInput('Jump'));
      jumpBtn.addEventListener('mousedown', () => sendInput('Jump'));

      // JOYSTICK
      const joyZone = document.getElementById('joystickZone');
      const stick = document.getElementById('stick');
      const center = { x: 100, y: 100 };
      const radius = 100;

      function updateStick(x, y) {
        stick.style.left = x + center.x - 40 + 'px';
        stick.style.top = y + center.y - 40 + 'px';
      }

      function normalize(x, y) {
        let nx = x / radius;
        let ny = y / radius;
        if (nx > 1) nx = 1;
        if (nx < -1) nx = -1;
        if (ny > 1) ny = 1;
        if (ny < -1) ny = -1;
        return { nx, ny };
      }

      function handleMove(touchX, touchY) {
        let rect = joyZone.getBoundingClientRect();
        let x = touchX - rect.left - center.x;
        let y = touchY - rect.top - center.y;

        let dist = Math.sqrt(x * x + y * y);
        if (dist > radius) {
          x = (x / dist) * radius;
          y = (y / dist) * radius;
        }

        updateStick(x, y);

        let { nx, ny } = normalize(x, y);
        sendInput(`Move:${nx.toFixed(2)}:${(-ny).toFixed(2)}`);
      }

      joyZone.addEventListener('touchstart', (e) => e.preventDefault());
      joyZone.addEventListener('touchmove', (e) => {
        e.preventDefault();
        let touch = e.touches[0];
        handleMove(touch.clientX, touch.clientY);
      });
      joyZone.addEventListener('touchend', () => {
        updateStick(0, 0);
        sendInput('Move:0:0');
      });

      joyZone.addEventListener('mousedown', (e) => {
        e.preventDefault();
        handleMove(e.clientX, e.clientY);
        function mouseMove(e) {
          handleMove(e.clientX, e.clientY);
        }
        function mouseUp() {
          updateStick(0, 0);
          sendInput('Move:0:0');
          window.removeEventListener('mousemove', mouseMove);
          window.removeEventListener('mouseup', mouseUp);
        }
        window.addEventListener('mousemove', mouseMove);
        window.addEventListener('mouseup', mouseUp);
      });
    </script>
  </body>
</html>
